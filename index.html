<html>
<head>
  <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js'></script>
  <style>
    * {
      font-family: verdana
    }
    .addButton {
      height: 2rem;
      margin-bottom: 0.5rem;
    }
    .destroy {
      margin-top: 1rem;
      height: 2rem;
      width: 100%;
    }
    /* hr {
      color: orange;
      background-color: orange;
      height: 0.1rem;
    } */
  </style>
</head>
<body>
  <div id='root'></div>
  <script type='text/babel'>
    const { Component } = React;
    const { render } = ReactDOM;
    const API = 'https://acme-users-api-rev.herokuapp.com/api';

    const fetchUser = async ()=> {
      const storage = window.localStorage;
      const userId = storage.getItem('userId');
      if(userId){
        try {
          return (await axios.get(`${API}/users/detail/${userId}`)).data;
        }
        catch(ex){
          storage.removeItem('userId');
          return fetchUser();
        }
      }
      const user = (await axios.get(`${API}/users/random`)).data;
      storage.setItem('userId', user.id);
      return user;
    };
    // users/:id/notes
    // await axios.get(`${API}/users/${user.id}/notes`)
    const Notes = ({ notes, error }) => {
      if ( notes.length === 5 ) {
        error = 'user can only have a max of 5 notes';
        // return error;
      }
      return (
      <div>
        <h1>Notes ({ notes.length })</h1>
        <button className='addButton'>Add A Random Note</button>
        < br />
        { 
          notes.map( note => <div key={note.id}>{note.text}</div>)
        }
        <button className='destroy'>Destroy</button>
        < hr />
      </div>
      )
    }
    // users/:id/followingCompanies
    // await axios.get(`${API}/users/${user.id}/followingCompanies`)
    const FollowingCompanies = ({ companies, followingCompanies, user, error }) => {
      let filteredComp = companies.filter( company => followingCompanies.find( followComp => company.id === followComp.companyId))
      if ( filteredComp.length === 5 ) {
        error = 'user is already following 5 companies';
        // return error;
      }
      return (
      <div>
        <h1>Following Companies ({ filteredComp.length })</h1>
        <button className='addButton'>Add A Random Following Company</button>
        < br />
        { 
          filteredComp.map(filComp => <div key={filComp.id}>{filComp.name}</div>)
        }
        <button className='destroy'>Destroy</button>
        < hr />
      </div>
      )
    }
    // users/:id/vacations
    // await axios.post(`${API}/users/${user.id}/vacations`)
    const Vacations = ({ vacations, error }) => {
      // console.log(vacations)
      if (vacations.length === 3) {
        error = 'user already has 3 vacations';
        // return error;
      }
      return (
      <div>
        <h1>Vacations ({vacations.length})</h1>
        <button className='addButton'>Add a Random Vacation</button> 
        < br />
        {
          <div>{moment(vacations.startDate).format('MM/DD/YYYY')} to {moment(vacations.endDate).format('MM/DD/YYYY')}</div>
        }
        <button className='destroy'>Destroy</button>
        < hr />
      </div>
      )
    }
  
    class App extends Component {
      constructor() {
        super();
        this.state = {
          user: {},
          companies: [],
          vacations: [],
          notes: [],
          followingCompanies: [],
          error: ''
        }
      }
      async componentDidMount() {
        const user = await fetchUser();
        const notes = (await axios.get(`${API}/users/${user.id}/notes`)).data;
        const followingCompanies = (await axios.get(`${API}/users/${user.id}/followingCompanies`)).data;
        const companies = (await axios.get(`${API}/companies`)).data;
        let vacations = (await axios.get(`${API}/users/${user.id}/vacations`)).data;
        if (vacations.length === 3) {
          await axios.delete(`${API}/users/${user.id}/vacations/${vacations[0].id}`);
        }
        const vacation = (await axios.post(`${API}/users/${user.id}/vacations`, { startDate: `10/31/2019`, endDate: '11/1/2019' } )).data;
        this.setState({ user, notes, followingCompanies, vacations, companies });
      }
      render() {
        const { error, user, companies, vacations, followingCompanies, notes } = this.state;
        console.log(user)
        return (
          <div>
            <h1>The Acme Random Life</h1>
            Welcome { user.fullName } to your Random Life!
            <div>write error here if exceeds limit</div>
            <div className='error'> { error } </div>
            <Notes notes = { notes } error = { error } />
            <FollowingCompanies user = { user } followingCompanies = { followingCompanies } companies = { companies } error = { error } />
            <Vacations vacations = { vacations } error = { error } />
          </div>
        )
      }
    }
    render( < App /> , root );
  </script>
</body>
</html>