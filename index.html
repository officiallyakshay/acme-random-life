<html>
<head>
  <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js'></script>
  <style>
    * {
      font-family: verdana
    }
    .addButton {
      height: 2rem;
      margin-bottom: 0.5rem;
    }
    .destroy {
      margin-top: 1rem;
      height: 2rem;
      width: 100%;
    }
    /* hr {
      color: orange;
      background-color: orange;
      height: 0.1rem;
    } */
  </style>
</head>
<body>
  <div id='root'></div>
  <script type='text/babel'>
    const { Component } = React;
    const { render } = ReactDOM;
    const API = 'https://acme-users-api-rev.herokuapp.com/api';

    const fetchUser = async ()=> {
      const storage = window.localStorage;
      const userId = storage.getItem('userId');
      if(userId){
        try {
          return (await axios.get(`${API}/users/detail/${userId}`)).data;
        }
        catch(ex){
          storage.removeItem('userId');
          return fetchUser();
        }
      }
      const user = (await axios.get(`${API}/users/random`)).data;
      storage.setItem('userId', user.id);
      return user;
    };
    // users/:id/notes
    // await axios.get(`${API}/users/${user.id}/notes`)
    const Notes = ({ notes, error, add, update, _delete }) => {
      if ( notes.length === 5 ) {
        error = 'user can only have a max of 5 notes';
        // return error;
      }
      return (
      <div>
        <h1>Notes ({ notes.length })</h1>
        <button className='addButton' onClick = { () => add() } >Add A Random Note</button>
        < br />
        {  
          notes.map( note => {
            return (
            <div key={note.id}>
            {note.text}
            <button className='destroy' onClick = { () =>_delete(note.id) } >Destroy</button>
            </div>
          )})
        }
        < hr />
      </div>
      )
    }
    // users/:id/followingCompanies
    // await axios.get(`${API}/users/${user.id}/followingCompanies`)
    const FollowingCompanies = ({ companies, followingCompanies, user, error, add, update, _delete }) => {
      let filteredComp = companies.filter( company => followingCompanies.find( followComp => company.id === followComp.companyId))
      // console.log(filteredComp)
      if ( filteredComp.length === 5 ) {
        error = 'user is already following 5 companies';
        // return error;
      }
      return (
      <div>
        <h1>Following Companies ({ filteredComp.length })</h1>
        <button className='addButton' onClick = { () => add() } >Add A Random Following Company</button>
        < br />
        { 
          filteredComp.map(filComp => {
            return (
            <div key={filComp.id}>
            {filComp.name}
            <button className='destroy' onClick = { () => _delete(filComp.id) } >Destroy</button>
            </div>
          )})
        }
        < hr />
      </div>
      )
    }
    // users/:id/vacations
    // await axios.post(`${API}/users/${user.id}/vacations`)
    const Vacations = ({ vacations, error, add, update,  _delete }) => {
      // console.log(vacations)
      if (vacations.length === 3) {
        error = 'user already has 3 vacations';
        // return error;
      }
      return (
      <div>
        <h1>Vacations ({vacations.length})</h1>
        <button className='addButton' onClick = { () => add() } >Add a Random Vacation</button> 
        < br />
        {
          // this.setState({ vacation: onClick() })
          // <div>{this.state.vacation}</div>
          vacations.map( vacation => {
            return (
              <div key = { vacation.id }>
              {moment(vacation.startDate).format('MM/DD/YYYY')} to {moment(vacation.endDate).format('MM/DD/YYYY')}
              <button className='destroy' onClick = { () => _delete(vacation.id) }>Destroy</button>
              </div>
            )})
        }
        < hr />
      </div>
      )
    }
  
    class App extends Component {
      constructor() {
        super();
        this.state = {
          user: {},
          companies: [],
          vacations: [],
          notes: [],
          followingCompanies: [],
          error: ''
        }
      }
      add = async (route, id) => {
        // if ( route === 'notes') {
          const note = (await axios.post(`${API}/users/${this.state.user.id}/notes`, { text: `lorem ipsum` } )).data;
          console.log(note)
          const notes = [...this.state.notes, note];
          this.setState({ notes });
        // }

        const filComp = (await axios.post(`${API}/users/${this.state.user.id}/followingCompanies`, { rating: 3, companyId: `${filComp.id}` } )).data;
        console.log(filComp)
        const companies = [...this.state.companies, filComp];
        this.setState({ companies }); 
        
        const vacation = (await axios.post(`${API}/users/${this.state.user.id}/vacations`, { startDate: moment('09/10/2019').format('MM/DD/YYYY'), endDate: moment('10/10/2019').format('MM/DD/YYYY') } )).data;
        console.log(vacation)
        const vacations = [...this.state.vacations, vacation];
        this.setState({ vacations });
        
      }
      update = async (id) => {
        await axios.put(`${API}/users/${user.id}/notes/${notes.id}`, { text: `${note.text} Updated` } );
        await axios.put(`${API}/users/${user.id}/followingCompanies/${followingCompanies.id}`, { rating: 3, companyId: `${filComp.id}` } );
        await axios.put(`${API}/users/${user.id}/vacations/${vacation.id}`, { startDate: `09/10/2019`, endDate: `10/10/2019` } )
        // vacations = (await axios.get(`${API}/users/${user.id}/vacations`)).data;
      
      }
      _delete = async (id) => {
        // if (notes.length === 5) {
          await axios.delete(`${API}/users/${this.state.user.id}/notes/${id}`);
        // }
        // if (followingCompanies.length === 5) {
          await axios.delete(`${API}/users/${this.state.user.id}/followingCompanies/${id}`);  
        // }
        // if (vacations.length === 3) {
          await axios.delete(`${API}/users/${this.state.user.id}/vacations/${id}`);
        // }
          const notes = this.state.notes.filter( note => note.id !== id );
          const followingCompanies = this.state.followingCompanies.filter( followComp => followComp.id !== id );
          const vacations = this.state.vacations.filter( vacation => vacation.id !== id );
          // const notes = this.state.notes.filter( note => note.id !== id )
          this.setState({ notes, followingCompanies, vacations });
      }
      async componentDidMount() {
        const user = await fetchUser();
        let notes = (await axios.get(`${API}/users/${user.id}/notes`)).data;
        let followingCompanies = (await axios.get(`${API}/users/${user.id}/followingCompanies`)).data;
        const companies = (await axios.get(`${API}/companies`)).data;
        let vacations = (await axios.get(`${API}/users/${user.id}/vacations`)).data;
        this.setState({ user, notes, followingCompanies, vacations, companies });
      }
      render() {
        const { error, user, companies, vacations, followingCompanies, notes, add, update, _delete } = this.state;
        // console.log( vacations )
        return (
          <div>
            <h1>The Acme Random Life</h1>
            Welcome { user.fullName } to your Random Life!
            <div className='error'> { error } </div>
            <Notes notes = { notes } error = { error } add = { this.add } update = { this.update } _delete = { this._delete } />
            <FollowingCompanies user = { user } followingCompanies = { followingCompanies } companies = { companies } error = { error } add = { this.add } update = { this.update } _delete = { this._delete } />
            <Vacations vacations = { vacations } error = { error } add = { this.add } update = { this.update } _delete = { this._delete } />
          </div>
        )
      }
    }
    render( < App /> , root );
  </script>
</body>
</html>